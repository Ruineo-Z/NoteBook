## 任务协议（Task-first）

### 1. 创建父任务

开始生成编曲提示词前，先创建父任务：
- 名称：`{song} 编曲提示词任务`
- 目标：在多轮修订后交付用户确认的编曲提示词终版

### 2. 创建子任务（固定映射）

按以下映射创建 7 个子任务：

- P1 -> 步骤1 启动检查
- P2 -> 步骤2 输入解析（分析报告 + 歌词）
- P3 -> 步骤3 编曲策略设计
- P4 -> 步骤4 英文版 Suno Prompt 生成
- P5 -> 步骤5 中文版解释稿生成
- P6 -> 步骤6 质量门禁与格式校验
- P7 -> 步骤7 用户确认与文件保存

### 3. 状态规则

每个子任务必须标记状态：
- `pending`
- `in_progress`
- `completed`
- `blocked`

执行规则：
- 同一时刻仅允许 1 个 `in_progress`
- 未完成当前子任务前，不进入下一子任务

### 4. 多轮调整规则（重点）

用户提出修改意见时：

1. 不新建父任务
2. 在同一父任务下追加修订子任务，例如：
   - `P4-R2 英文版修订`
   - `P5-R2 中文版同步修订`
   - `P6-R2 复检`
3. 每轮记录修改摘要（改了什么、为什么改）
4. 用户未确认前，父任务保持 `in_progress`

### 5. 完成条件

仅当满足以下条件，父任务才可标记完成：

- 用户明确确认终版编曲提示词
- 格式校验通过（脚本返回 `success: true`）
- 质量门禁通过
- 文件 `{song}-arrangement.txt` 已保存
- 已完成交付说明

### 6. 推荐任务模板

```text
父任务：{song} 编曲提示词任务 [in_progress]
- P1 启动检查 [completed]
- P2 输入解析 [completed]
- P3 编曲策略设计 [completed]
- P4 英文版生成 [completed]
- P5 中文版生成 [completed]
- P6 校验与复检 [in_progress]
- P7 保存与交付 [pending]

修订轮次（如有）：
- P4-R2 英文版修订 [completed]
- P5-R2 中文版同步修订 [completed]
- P6-R2 复检 [in_progress]
```
